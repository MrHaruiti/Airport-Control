
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Simulador Completo - Controle de Pátio</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; }
    h1 { margin-top: 0; }
    .painel { display: flex; flex-wrap: wrap; gap: 15px; }
    .voo { background: white; padding: 10px; border-radius: 5px; width: 300px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .status { font-weight: bold; margin: 5px 0; }
    .delayed { color: orange; }
    .cancelado { color: red; }
    .emsolo { color: green; }
    button { margin-top: 5px; width: 100%; }
    select { width: 100%; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Simulador Completo de Controle de Pátio</h1>
  <div id="hora"></div>
  <div id="painel" class="painel"></div>

<script>
let data = {};
let exibidos = new Set();
let aeronavesEmSolo = [];
let bloqueioPouso = false;
let bloqueioDecolagem = false;

function atualizarHora() {
  const agora = new Date();
  document.getElementById("hora").innerText = "Hora atual: " + agora.toLocaleTimeString();
  return agora;
}

function carregarVoos() {
  fetch('voos.json')
    .then(resp => resp.json())
    .then(json => {
      data = json;
    });
}

function mostrarVoos(agora) {
  const painel = document.getElementById("painel");
  const todos = data.chegadas.concat(data.partidas.map(p => ({...p, tipo: "partida"})));

  todos.forEach(voo => {
    if (exibidos.has(voo.voo)) return;

    const [h, m] = voo.horario.split(":").map(Number);
    const horaVoo = new Date();
    horaVoo.setHours(h, m, 0, 0);
    const diffMin = (horaVoo - agora) / 60000;

    if (voo.tipo === "partida") {
      if (aeronavesEmSolo.find(a => a.companhia === voo.companhia && a.aeronave === voo.aeronave) && diffMin <= 0) {
        criarPainelPartida(voo);
        exibidos.add(voo.voo);
      }
    } else {
      if (diffMin <= 60 && diffMin >= -15) {
        criarPainelChegada(voo, diffMin);
        exibidos.add(voo.voo);
      }
    }
  });
}

function criarPainelChegada(voo, diffMin) {
  const painel = document.getElementById("painel");
  const div = document.createElement("div");
  div.className = "voo";
  div.id = "voo-" + voo.voo;
  const status = diffMin < -15 ? "Delayed" : "Aguardando";
  div.innerHTML = `
    <strong>${voo.companhia} - ${voo.voo}</strong><br>
    Aeronave: ${voo.aeronave}<br>
    TPS: ${voo.tps || "-"}<br>
    Horário: ${voo.horario}<br>
    <div class="status" id="status-${voo.voo}">${status}</div>
    <div class="controles" id="controles-${voo.voo}">
      <button onclick="autorizarPouso('${voo.voo}')">Pousar</button>
      <button onclick="marcarAtrasado('${voo.voo}')">Atrasado</button>
      <button onclick="cancelar('${voo.voo}')">Cancelar</button>
    </div>
  `;
  painel.appendChild(div);
}

function criarPainelPartida(voo) {
  const painel = document.getElementById("painel");
  const div = document.createElement("div");
  div.className = "voo";
  div.id = "partida-" + voo.voo;
  div.innerHTML = `
    <strong>${voo.companhia} - ${voo.voo}</strong><br>
    Aeronave: ${voo.aeronave}<br>
    Destino: ${voo.destino || "-"}<br>
    Saída: ${voo.horario}<br>
    <div class="status" id="status-${voo.voo}">Aguardando Pushback</div>
    <div id="controles-${voo.voo}">
      <button onclick="autorizarPushback('${voo.voo}')">Pushback</button>
    </div>
  `;
  painel.appendChild(div);
}

function atualizarStatus(id, texto, classe="") {
  const el = document.getElementById("status-" + id);
  el.innerText = texto;
  el.className = "status " + classe;
}

function removerControles(id) {
  const el = document.getElementById("controles-" + id);
  if (el) el.remove();
}

function autorizarPouso(vooId) {
  if (bloqueioPouso) return alert("Aguarde 35 segundos para novo pouso.");
  atualizarStatus(vooId, "Pousando...");
  removerControles(vooId);
  bloqueioPouso = true;
  setTimeout(() => {
    atualizarStatus(vooId, "Em solo", "emsolo");
    const voo = data.chegadas.find(v => v.voo === vooId);
    aeronavesEmSolo.push({companhia: voo.companhia, aeronave: voo.aeronave});
  }, 5 * 60 * 1000); // 5 minutos
  setTimeout(() => {
    bloqueioPouso = false;
  }, 35 * 1000);
}

function autorizarPushback(vooId) {
  atualizarStatus(vooId, "Taxiando...");
  removerControles(vooId);
  setTimeout(() => {
    const div = document.getElementById("partida-" + vooId);
    const controles = document.createElement("div");
    controles.id = "controles-" + vooId;
    controles.innerHTML = `<button onclick="autorizarDecolagem('${vooId}')">Autorizar Decolagem</button>`;
    div.appendChild(controles);
    atualizarStatus(vooId, "Pronto para decolar");
  }, 5 * 60 * 1000); // 5 minutos taxiando
}

function autorizarDecolagem(vooId) {
  if (bloqueioDecolagem) return alert("Aguarde 20 segundos entre decolagens.");
  atualizarStatus(vooId, "Decolando...");
  removerControles(vooId);
  bloqueioDecolagem = true;
  setTimeout(() => {
    const div = document.getElementById("partida-" + vooId);
    if (div) div.remove();
  }, 15000); // 15 segundos
  setTimeout(() => {
    bloqueioDecolagem = false;
  }, 20000);
}

function marcarAtrasado(id) {
  atualizarStatus(id, "Delayed", "delayed");
}

function cancelar(id) {
  atualizarStatus(id, "Cancelado", "cancelado");
  removerControles(id);
  setTimeout(() => {
    const el = document.getElementById("voo-" + id);
    if (el) el.remove();
  }, 60 * 60 * 1000);
}

function loop() {
  const agora = atualizarHora();
  mostrarVoos(agora);
}

carregarVoos();
setInterval(loop, 10000);
</script>
</body>
</html>
